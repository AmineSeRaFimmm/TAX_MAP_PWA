<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全球税率地图</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { 
            height: 600px; 
            width: 100%; 
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .leaflet-container {
            background: #f0f4f8;
        }

        .leaflet-popup-content-wrapper {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            padding: 4px;
            font-family: 'Arial', sans-serif;
        }

        .leaflet-popup-content {
            width: 100px !important;
            margin: 0;
            line-height: 1.2;
            color: #333;
            font-size: 10px;
        }

        .leaflet-popup-content b {
            color: #1a73e8;
            font-size: 12px;
            display: block;
            margin-bottom: 4px;
        }

        .button-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
        }

        .button-container button {
            padding: 8px 16px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-width: 100px;
        }

        .button-container button:hover {
            background-color: #1557b0;
        }

        @media screen and (max-width: 480px) {
            .button-container button {
                min-width: 80px;
                font-size: 12px;
                padding: 6px 12px;
            }
        }

        .table-container {
            display: none; /* 默认隐藏 */
            width: 100%;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }

        /* 仅在移动设备竖屏时显示表格 */
        @media screen and (orientation: portrait) and (max-width: 768px) {
            .table-container {
                display: block;
            }
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .tab-button {
            padding: 10px 20px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .tab-button:hover {
            background-color: #1557b0;
        }

        .tab-button.active {
            background-color: #0d47a1;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Arial', sans-serif;
            font-size: 12px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="button-container">
        <button id="toggleButton">成品出口</button>
        <button id="toggleOrangeButton">拟建工厂出口</button>
        <button id="toggleGreenButton">铝锭出口税</button>
    </div>
    <div id="map"></div>
    <div class="table-container">
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="existing">现有工厂</button>
            <button class="tab-button" data-tab="planned">拟建工厂</button>
            <button class="tab-button" data-tab="aluminum">铝锭供应商</button>
        </div>
        <div class="tab-content active" id="existing-tab"></div>
        <div class="tab-content" id="planned-tab"></div>
        <div class="tab-content" id="aluminum-tab"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const BLUE_COLOR = '#4682B4';
            const ORANGE_COLOR = '#FFA500';
            const GREEN_COLOR = '#2ecc71';

            // 初始化地图，使用高德地图瓦片
            var map = L.map('map').setView([20, 0], 3);
            L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                subdomains: ['1', '2', '3', '4'],
                attribution: '© 高德地图'
            }).addTo(map);

            // 地图瓦片加载错误处理
            map.on('tileerror', function(error) {
                console.error('地图瓦片加载失败:', error);
            });

            // 创建自定义标记图标
            function createIcon(color, gradientColors) {
                return L.divIcon({
                    className: 'custom-dot',
                    html: `<div style="background: linear-gradient(45deg, ${gradientColors.join(', ')}); width: 10px; height: 10px; border-radius: 50%; border: 2px solid #fff;"></div>`,
                    iconSize: [10, 10],
                    iconAnchor: [5, 5],
                    popupAnchor: [0, -5]
                });
            }

            // 定义标记图标
            const blueDotIcon = createIcon(BLUE_COLOR, ['#3498db', '#2980b9']);
            const orangeDotIcon = createIcon(ORANGE_COLOR, ['#e67e22', '#d35400']);
            const greenSquareIcon = createIcon(GREEN_COLOR, ['#2ecc71', '#27ae60']);

            // 数据定义
            const factories = [
                { name: "中国CN", coords: [39.9354, 119.5996], tariffs: { US: "27.5%", EU: "25.3%" }, color: BLUE_COLOR, icon: blueDotIcon },
                { name: "美国US", coords: [42.3314, -83.0458], tariffs: { US: "0%", EU: "0%" }, color: BLUE_COLOR, icon: blueDotIcon },
                { name: "墨西哥MEX", coords: [25.6866, -100.3161], tariffs: { US: "0%", EU: "0%" }, color: BLUE_COLOR, icon: blueDotIcon }
            ];

            const newFactories = [
                { name: "葡萄牙PT", coords: [38.7223, -9.1393], tariffs: { US: "2.5%", EU: "0%" }, color: ORANGE_COLOR, icon: orangeDotIcon },
                { name: "越南VN", coords: [21.0278, 105.8342], tariffs: { US: "2.5%", EU: "2.5%" }, color: ORANGE_COLOR, icon: orangeDotIcon }
            ];

            const greenFactories = [
                { name: "迪拜AE", coords: [25.2048, 55.2708], tariffs: { DE: "0%", US: "25%" }, color: GREEN_COLOR, icon: greenSquareIcon },
                { name: "莫斯科RU", coords: [55.7558, 37.6173], tariffs: { DE: "0%", US: "25%" }, color: GREEN_COLOR, icon: greenSquareIcon }
            ];

            const allFactories = factories.concat(newFactories, greenFactories);
            const blueMarkers = [];
            const orangeMarkers = [];
            const greenMarkers = [];

            // 创建标记
            function createMarkers(factories) {
                factories.forEach(factory => {
                    const marker = L.marker(factory.coords, { icon: factory.icon }).addTo(map);
                    const popupContent = `<b>${factory.name}</b><br>` + 
                        Object.entries(factory.tariffs).map(([key, value]) => `${key}: ${value}`).join('<br>');
                    marker.bindPopup(popupContent, { autoClose: false, closeOnClick: false });
                    marker.openPopup();

                    if (factory.color === BLUE_COLOR) blueMarkers.push(marker);
                    else if (factory.color === ORANGE_COLOR) orangeMarkers.push(marker);
                    else if (factory.color === GREEN_COLOR) greenMarkers.push(marker);
                });
            }

            createMarkers(allFactories);

            // 按钮切换功能
            document.getElementById('toggleButton').addEventListener('click', () => {
                blueMarkers.forEach(marker => marker.isPopupOpen() ? marker.closePopup() : marker.openPopup());
            });

            document.getElementById('toggleOrangeButton').addEventListener('click', () => {
                orangeMarkers.forEach(marker => marker.isPopupOpen() ? marker.closePopup() : marker.openPopup());
            });

            document.getElementById('toggleGreenButton').addEventListener('click', () => {
                greenMarkers.forEach(marker => marker.isPopupOpen() ? marker.closePopup() : marker.openPopup());
            });

            // 生成表格
            function generateTable(data, containerId, headers) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`未找到容器: ${containerId}`);
                    return;
                }
                const table = document.createElement('table');
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');

                const headerRow = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                data.forEach(item => {
                    const row = document.createElement('tr');
                    const nameCell = document.createElement('td');
                    nameCell.textContent = item.name;
                    row.appendChild(nameCell);

                    const coordsCell = document.createElement('td');
                    coordsCell.textContent = `(${item.coords[0]}, ${item.coords[1]})`;
                    row.appendChild(coordsCell);

                    const tariffsCell = document.createElement('td');
                    tariffsCell.innerHTML = Object.entries(item.tariffs).map(([key, value]) => `${key}: ${value}`).join('<br>');
                    row.appendChild(tariffsCell);

                    tbody.appendChild(row);
                });
                table.appendChild(tbody);
                container.appendChild(table);
                console.log(`表格已生成并添加到 ${containerId}`);
            }

            // 初始化表格
            generateTable(factories, 'existing-tab', ['工厂名称', '坐标', '税率']);
            generateTable(newFactories, 'planned-tab', ['工厂名称', '坐标', '税率']);
            generateTable(greenFactories, 'aluminum-tab', ['供应商名称', '坐标', '税率']);

            // 选项卡切换
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(button.dataset.tab + '-tab').classList.add('active');
                });
            });

            // 动态调整表格显示
            function updateTableDisplay() {
                const isMobile = window.innerWidth <= 768;
                const isPortrait = window.innerWidth < window.innerHeight;
                const tableContainer = document.querySelector('.table-container');
                tableContainer.style.display = (isMobile && isPortrait) ? 'block' : 'none';
            }

            window.addEventListener('resize', updateTableDisplay);
            window.addEventListener('orientationchange', updateTableDisplay);
            updateTableDisplay();
        });
    </script>
</body>
</html>